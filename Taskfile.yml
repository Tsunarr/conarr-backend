# https://taskfile.dev

tasks:
  bruno:all:
    cmds:
      - task: bruno:test:PR
  bruno:test:PR:
    cmds:
      - bru run --env "Jellyfin_PR"
    dir: bruno/pyconarr
    silent: true
  docker:build:
    cmds:
      - docker build -t pyconarr:test .
    silent: true
  docker:test:
    cmds:
      - docker run --rm pyconarr:test python --version
    deps:
      - docker:build
    silent: true
  docker:it:
    cmds:
      - docker run -it --rm pyconarr:test "/bin/sh"
    deps:
      - docker:build
    silent: true
  install:
    cmds:
      - poetry install
    internal: true
    silent: true
  megalinter:test:
    cmds:
      - docker run --pull=always --rm -v ${LOCALWORKSPACE}:/tmp/lint -w
        /tmp/lint oxsecurity/megalinter:v7
    silent: true
  poetry:build:
    cmds:
      - poetry build
    deps:
      - install
    silent: true
  poetry:coverage:
    cmds:
      - poetry run coverage xml
      - poetry run coverage lcov
    internal: true
    silent: true
  poetry:run:
    cmds:
      - poetry run uvicorn --app-dir pyconarr main:app --reload
        --log-config=config/log.yaml
    deps:
      - install
    interactive: true
    silent: true
  poetry:test:all:
    cmds:
      - poetry run pytest
      - task: poetry:coverage
    silent: true
  poetry:test:ci:
    cmds:
      - poetry run pytest -m "unit or component"
      - task: poetry:coverage
    deps:
      - install
    silent: true
  poetry:test:component:
    cmds:
      - poetry run pytest -m component
      - task: poetry:coverage
    deps:
      - install
    silent: true
  poetry:test:integration:
    cmds:
      - poetry run pytest -m integration
      - poetry run coverage xml
    deps:
      - install
    silent: true
  poetry:test:unit:
    cmds:
      - poetry run pytest -m unit
      - task: poetry:coverage
    deps:
      - install
    silent: true
version: "3"
